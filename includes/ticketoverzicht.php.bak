<?php 
include_once FILE_TICKETSYSTEEM;
include_once FILE_AFDELING;
include_once FILE_GEBRUIKER;

$ticket = new Ticketsysteem;
$afdeling = new Afdeling();
$gebruiker = new Gebruiker(new DbGebruiker());

$ticket_array = $ticket->getTicketArray();
$afdeling_array = $afdeling->getList();
$gebruiker_array = $gebruiker->getGebruikerList();

$count_gebruiker_array = count($gebruiker_array);
$countArray = count($ticket_array);
$count_afdeling_array = count($afdeling_array);
?>

<h2>Ticket overzicht</h2>
<table class="tabel">
    <thead> 
       <tr>
            <th>Titel</th>
            <th>Beschrijving</th>
            <th>Voortgang</th>
            <th>Afdeling</th>
            <th>Object</th>
            <th>Priorteit</th>
            <th>Acties</th>
        </tr>
    </thead>
    <tbody>
<?php
    for ($i = 0; $i < $countArray; $i++) {
        echo '<form method="post" name="form1" id="ticketverwijzen" action="#">';
        echo '<tr>';
        echo '<td>';
        echo $ticket_array[$i]['ticket_titel'];
        echo '</td>';
        echo '<td>';
        echo $ticket_array[$i]['ticket_beschrijving'];
        echo '</td>';
        echo '<td>';
        echo $ticket_array[$i]['ticket_progress'];
        echo '</td>';
        echo '<td>';
        $afdeling = $ticket->getAfdeling($ticket_array[$i]['afdeling_id']);
       // $object->getAfdeling($object_array[$i]['afdeling_id']);
        if(isset($afdeling[0]['afdeling_naam'])){
            echo $afdeling[0]['afdeling_naam'];
        }
        echo '</td>';
        echo '<td>';
        //var_dump($ticket->getObject($ticket_array[$i]['object_id']));
        $object = $ticket->getObject($ticket_array[$i]['object_id']);
       // $object->getAfdeling($object_array[$i]['afdeling_id']);
        if(isset($object[0]['object_naam'])){
            echo $object[0]['object_naam'];
        }
        echo '</td>';
        echo '<td>';
        echo $ticket_array[$i]['ticket_prio_id'];
        echo '</td>';
        echo '<td>';
        ?>
        <select name="gebruiker" id="gebruiker" title="Kies hier de gebruiker die dit ticket moet afhandelen" required>
            <option>Maak een keuze</option>
            <?php 
            for ($a = 0; $a < $count_gebruiker_array; $a++) {
                if($gebruiker_array[$a]['gebruiker_id'] == $ticket_array[$i]['pers_id']){
                    echo '<option selected value="'.$gebruiker_array[$a]['gebruiker_id'].'">'.$gebruiker_array[$a]['gebruiker_naam'].'</option>';
                }else{
                    echo '<option value="'.$gebruiker_array[$a]['gebruiker_id'].'">'.$gebruiker_array[$a]['gebruiker_naam'].'</option>';    
                }
            }
            ?>
        </select>
        <?php
        echo '<br />';
        echo '<input type="hidden" name="id" value="'.$ticket_array[$i]['ticket_id'].'">';
        echo '<input type="submit" class="knopje" name="Verzenden" value="Toewijzen" />';
        echo '</td>';
        echo '</tr>';
        echo '</form>';
    }
    
    if(isset($_POST['Verzenden'])) {
        /**
         * Nieuwe instantie van ticketsysteem maken.
         * Alles setten.
         */
        // get ticket by id
        $current = $ticket->getTicketByID($_POST['id']);
        
        $ticket->__set('pers_id', $_POST['gebruiker']);
        $ticket->__set('titel', $current['ticket_titel']);
        $ticket->__set('afdeling', $current['afdeling_id']);
        $ticket->__set('object', $current['object_id']);
        $ticket->__set('beschrijving', $current['ticket_beschrijving']);
        $ticket->__set('progress', 'In behandeling');
        $ticket->__set('prioid', $current['ticket_prio_id']);
        $ticket->__set('ticket_status_id', '1');
        $ticket->__set('ticket_end_tijd', $current['ticket_end_tijd']);
        $ticket->updateTicket();
        /**
         * Ticket opslaan in database
         */
        

        echo "<div id='result'>";
        echo 'Uw ticket is <strong>succesvol</strong> aangemaakt!';
        echo "</div>";
    }
?>
    </tbody>
</table>